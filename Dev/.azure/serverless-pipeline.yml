trigger:
  batch: true

pool:
  vmImage: 'windows-2022'

stages:
- stage: Compile
  jobs:
  
  - job: build
    displayName: 'Compile'
  
    steps:
    - task: PowerShell@2
      inputs:
        filePath: '$(Agent.BuildDirectory)/s/Compile.ps1'
        arguments: '-AcceptanceTesting -MSBuildPath "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe"'
        displayName: 'Compile'
  
    - task: DeleteFiles@1
      inputs:
        SourceFolder: '$(Agent.BuildDirectory)\\s\\bin\\AcceptanceTesting'
        Contents: 'TestResults'

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Agent.BuildDirectory)\s\bin\AcceptanceTesting'
        ArtifactName: 'TestBinaries'
        publishLocation: 'Container'
        StoreAsTar: false
        
- stage: Test
  jobs:
  
  - job: Serverless_Tests_0
    displayName: 'Serverless Tests'
  
    steps:
    - checkout: none
    
    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'current'
        artifactName: 'TestBinaries'
        targetPath: '$(Agent.BuildDirectory)'
  
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          $address = $env:UseThisServerlessAddress
          $username = $env:UseThisServerlessUsername
          $password = $env:UseThisServerlessPassword 
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          Write-Host Testing against $address
          Test-NetConnection -Port 3142 $address
          New-LocalUser -Name $username -Password $securePassword -PasswordNeverExpires
          Add-LocalGroupMember -Group Administrators -Member $username
          $credential = New-Object System.Management.Automation.PSCredential $username, $securePassword
          netsh interface portproxy add v4tov4 listenport=3142 listenaddress=127.0.0.1 connectport=3142 connectaddress=$address
          netsh interface portproxy add v4tov4 listenport=3142 listenaddress=$env:ComputerName connectport=3142 connectaddress=$address
          Start-Process -Wait -Credential $credential -FilePath powershell -ArgumentList '-NoProfile -NoLogo -ExecutionPolicy Bypass -File "$(Agent.BuildDirectory)\RunServerlessTests500TimesInParallel.ps1"'
        displayName: 'Run Tests'
      env:
        UseThisServerlessUsername: $(ServerlessUsername)
        UseThisServerlessPassword: $(ServerlessPassword)
        UseThisServerlessAddress: $(ServerlessAddress)
  
    - task: PublishTestResults@2
      inputs:
        testRunner: VSTest
        testResultsFiles: '$(Agent.BuildDirectory)\TestResults\*.trx'
        failTaskOnFailedTests: true
        testRunTitle: 'Serverless Tests'
        
    - script: 'if not exist "$(Agent.BuildDirectory)\TestResults\*.trx" exit 1'
  
  - job: Serverless_Tests_1
    displayName: 'Serverless Tests'
  
    steps:
    - checkout: none
    
    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'current'
        artifactName: 'TestBinaries'
        targetPath: '$(Agent.BuildDirectory)'
  
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          $address = $env:UseThisServerlessAddress
          $username = $env:UseThisServerlessUsername
          $password = $env:UseThisServerlessPassword 
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          Write-Host Testing against $address
          Test-NetConnection -Port 3142 $address
          New-LocalUser -Name $username -Password $securePassword -PasswordNeverExpires
          Add-LocalGroupMember -Group Administrators -Member $username
          $credential = New-Object System.Management.Automation.PSCredential $username, $securePassword
          netsh interface portproxy add v4tov4 listenport=3142 listenaddress=127.0.0.1 connectport=3142 connectaddress=$address
          netsh interface portproxy add v4tov4 listenport=3142 listenaddress=$env:ComputerName connectport=3142 connectaddress=$address
          Start-Process -Wait -Credential $credential -FilePath powershell -ArgumentList '-NoProfile -NoLogo -ExecutionPolicy Bypass -File "$(Agent.BuildDirectory)\RunServerlessTests500TimesInParallel.ps1"'
        displayName: 'Run Tests'
      env:
        UseThisServerlessUsername: $(ServerlessUsername)
        UseThisServerlessPassword: $(ServerlessPassword)
        UseThisServerlessAddress: $(ServerlessAddress)
  
    - task: PublishTestResults@2
      inputs:
        testRunner: VSTest
        testResultsFiles: '$(Agent.BuildDirectory)\TestResults\*.trx'
        failTaskOnFailedTests: true
        testRunTitle: 'Serverless Tests'
        
    - script: 'if not exist "$(Agent.BuildDirectory)\TestResults\*.trx" exit 1'
  
  - job: Serverless_Tests_2
    displayName: 'Serverless Tests'
  
    steps:
    - checkout: none
    
    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'current'
        artifactName: 'TestBinaries'
        targetPath: '$(Agent.BuildDirectory)'
  
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          $address = $env:UseThisServerlessAddress
          $username = $env:UseThisServerlessUsername
          $password = $env:UseThisServerlessPassword 
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          Write-Host Testing against $address
          Test-NetConnection -Port 3142 $address
          New-LocalUser -Name $username -Password $securePassword -PasswordNeverExpires
          Add-LocalGroupMember -Group Administrators -Member $username
          $credential = New-Object System.Management.Automation.PSCredential $username, $securePassword
          netsh interface portproxy add v4tov4 listenport=3142 listenaddress=127.0.0.1 connectport=3142 connectaddress=$address
          netsh interface portproxy add v4tov4 listenport=3142 listenaddress=$env:ComputerName connectport=3142 connectaddress=$address
          Start-Process -Wait -Credential $credential -FilePath powershell -ArgumentList '-NoProfile -NoLogo -ExecutionPolicy Bypass -File "$(Agent.BuildDirectory)\RunServerlessTests500TimesInParallel.ps1"'
        displayName: 'Run Tests'
      env:
        UseThisServerlessUsername: $(ServerlessUsername)
        UseThisServerlessPassword: $(ServerlessPassword)
        UseThisServerlessAddress: $(ServerlessAddress)
  
    - task: PublishTestResults@2
      inputs:
        testRunner: VSTest
        testResultsFiles: '$(Agent.BuildDirectory)\TestResults\*.trx'
        failTaskOnFailedTests: true
        testRunTitle: 'Serverless Tests'
        
    - script: 'if not exist "$(Agent.BuildDirectory)\TestResults\*.trx" exit 1'
  
  - job: Serverless_Tests_3
    displayName: 'Serverless Tests'
  
    steps:
    - checkout: none
    
    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'current'
        artifactName: 'TestBinaries'
        targetPath: '$(Agent.BuildDirectory)'
  
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          $address = $env:UseThisServerlessAddress
          $username = $env:UseThisServerlessUsername
          $password = $env:UseThisServerlessPassword 
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          Write-Host Testing against $address
          Test-NetConnection -Port 3142 $address
          New-LocalUser -Name $username -Password $securePassword -PasswordNeverExpires
          Add-LocalGroupMember -Group Administrators -Member $username
          $credential = New-Object System.Management.Automation.PSCredential $username, $securePassword
          netsh interface portproxy add v4tov4 listenport=3142 listenaddress=127.0.0.1 connectport=3142 connectaddress=$address
          netsh interface portproxy add v4tov4 listenport=3142 listenaddress=$env:ComputerName connectport=3142 connectaddress=$address
          Start-Process -Wait -Credential $credential -FilePath powershell -ArgumentList '-NoProfile -NoLogo -ExecutionPolicy Bypass -File "$(Agent.BuildDirectory)\RunServerlessTests500TimesInParallel.ps1"'
        displayName: 'Run Tests'
      env:
        UseThisServerlessUsername: $(ServerlessUsername)
        UseThisServerlessPassword: $(ServerlessPassword)
        UseThisServerlessAddress: $(ServerlessAddress)
  
    - task: PublishTestResults@2
      inputs:
        testRunner: VSTest
        testResultsFiles: '$(Agent.BuildDirectory)\TestResults\*.trx'
        failTaskOnFailedTests: true
        testRunTitle: 'Serverless Tests'
        
    - script: 'if not exist "$(Agent.BuildDirectory)\TestResults\*.trx" exit 1'
  
  - job: Serverless_Tests_4
    displayName: 'Serverless Tests'
  
    steps:
    - checkout: none
    
    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'current'
        artifactName: 'TestBinaries'
        targetPath: '$(Agent.BuildDirectory)'
  
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          $address = $env:UseThisServerlessAddress
          $username = $env:UseThisServerlessUsername
          $password = $env:UseThisServerlessPassword 
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          Write-Host Testing against $address
          Test-NetConnection -Port 3142 $address
          New-LocalUser -Name $username -Password $securePassword -PasswordNeverExpires
          Add-LocalGroupMember -Group Administrators -Member $username
          $credential = New-Object System.Management.Automation.PSCredential $username, $securePassword
          netsh interface portproxy add v4tov4 listenport=3142 listenaddress=127.0.0.1 connectport=3142 connectaddress=$address
          netsh interface portproxy add v4tov4 listenport=3142 listenaddress=$env:ComputerName connectport=3142 connectaddress=$address
          Start-Process -Wait -Credential $credential -FilePath powershell -ArgumentList '-NoProfile -NoLogo -ExecutionPolicy Bypass -File "$(Agent.BuildDirectory)\RunServerlessTests500TimesInParallel.ps1"'
        displayName: 'Run Tests'
      env:
        UseThisServerlessUsername: $(ServerlessUsername)
        UseThisServerlessPassword: $(ServerlessPassword)
        UseThisServerlessAddress: $(ServerlessAddress)
  
    - task: PublishTestResults@2
      inputs:
        testRunner: VSTest
        testResultsFiles: '$(Agent.BuildDirectory)\TestResults\*.trx'
        failTaskOnFailedTests: true
        testRunTitle: 'Serverless Tests'
        
    - script: 'if not exist "$(Agent.BuildDirectory)\TestResults\*.trx" exit 1'
  
  - job: Serverless_Tests_5
    displayName: 'Serverless Tests'
  
    steps:
    - checkout: none
    
    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'current'
        artifactName: 'TestBinaries'
        targetPath: '$(Agent.BuildDirectory)'
  
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          $address = $env:UseThisServerlessAddress
          $username = $env:UseThisServerlessUsername
          $password = $env:UseThisServerlessPassword 
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          Write-Host Testing against $address
          Test-NetConnection -Port 3142 $address
          New-LocalUser -Name $username -Password $securePassword -PasswordNeverExpires
          Add-LocalGroupMember -Group Administrators -Member $username
          $credential = New-Object System.Management.Automation.PSCredential $username, $securePassword
          netsh interface portproxy add v4tov4 listenport=3142 listenaddress=127.0.0.1 connectport=3142 connectaddress=$address
          netsh interface portproxy add v4tov4 listenport=3142 listenaddress=$env:ComputerName connectport=3142 connectaddress=$address
          Start-Process -Wait -Credential $credential -FilePath powershell -ArgumentList '-NoProfile -NoLogo -ExecutionPolicy Bypass -File "$(Agent.BuildDirectory)\RunServerlessTests500TimesInParallel.ps1"'
        displayName: 'Run Tests'
      env:
        UseThisServerlessUsername: $(ServerlessUsername)
        UseThisServerlessPassword: $(ServerlessPassword)
        UseThisServerlessAddress: $(ServerlessAddress)
  
    - task: PublishTestResults@2
      inputs:
        testRunner: VSTest
        testResultsFiles: '$(Agent.BuildDirectory)\TestResults\*.trx'
        failTaskOnFailedTests: true
        testRunTitle: 'Serverless Tests'
        
    - script: 'if not exist "$(Agent.BuildDirectory)\TestResults\*.trx" exit 1'
  
  - job: Serverless_Tests_6
    displayName: 'Serverless Tests'
  
    steps:
    - checkout: none
    
    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'current'
        artifactName: 'TestBinaries'
        targetPath: '$(Agent.BuildDirectory)'
  
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          $address = $env:UseThisServerlessAddress
          $username = $env:UseThisServerlessUsername
          $password = $env:UseThisServerlessPassword 
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          Write-Host Testing against $address
          Test-NetConnection -Port 3142 $address
          New-LocalUser -Name $username -Password $securePassword -PasswordNeverExpires
          Add-LocalGroupMember -Group Administrators -Member $username
          $credential = New-Object System.Management.Automation.PSCredential $username, $securePassword
          netsh interface portproxy add v4tov4 listenport=3142 listenaddress=127.0.0.1 connectport=3142 connectaddress=$address
          netsh interface portproxy add v4tov4 listenport=3142 listenaddress=$env:ComputerName connectport=3142 connectaddress=$address
          Start-Process -Wait -Credential $credential -FilePath powershell -ArgumentList '-NoProfile -NoLogo -ExecutionPolicy Bypass -File "$(Agent.BuildDirectory)\RunServerlessTests500TimesInParallel.ps1"'
        displayName: 'Run Tests'
      env:
        UseThisServerlessUsername: $(ServerlessUsername)
        UseThisServerlessPassword: $(ServerlessPassword)
        UseThisServerlessAddress: $(ServerlessAddress)
  
    - task: PublishTestResults@2
      inputs:
        testRunner: VSTest
        testResultsFiles: '$(Agent.BuildDirectory)\TestResults\*.trx'
        failTaskOnFailedTests: true
        testRunTitle: 'Serverless Tests'
        
    - script: 'if not exist "$(Agent.BuildDirectory)\TestResults\*.trx" exit 1'
  
  - job: Serverless_Tests_7
    displayName: 'Serverless Tests'
  
    steps:
    - checkout: none
    
    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'current'
        artifactName: 'TestBinaries'
        targetPath: '$(Agent.BuildDirectory)'
  
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          $address = $env:UseThisServerlessAddress
          $username = $env:UseThisServerlessUsername
          $password = $env:UseThisServerlessPassword 
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          Write-Host Testing against $address
          Test-NetConnection -Port 3142 $address
          New-LocalUser -Name $username -Password $securePassword -PasswordNeverExpires
          Add-LocalGroupMember -Group Administrators -Member $username
          $credential = New-Object System.Management.Automation.PSCredential $username, $securePassword
          netsh interface portproxy add v4tov4 listenport=3142 listenaddress=127.0.0.1 connectport=3142 connectaddress=$address
          netsh interface portproxy add v4tov4 listenport=3142 listenaddress=$env:ComputerName connectport=3142 connectaddress=$address
          Start-Process -Wait -Credential $credential -FilePath powershell -ArgumentList '-NoProfile -NoLogo -ExecutionPolicy Bypass -File "$(Agent.BuildDirectory)\RunServerlessTests500TimesInParallel.ps1"'
        displayName: 'Run Tests'
      env:
        UseThisServerlessUsername: $(ServerlessUsername)
        UseThisServerlessPassword: $(ServerlessPassword)
        UseThisServerlessAddress: $(ServerlessAddress)
  
    - task: PublishTestResults@2
      inputs:
        testRunner: VSTest
        testResultsFiles: '$(Agent.BuildDirectory)\TestResults\*.trx'
        failTaskOnFailedTests: true
        testRunTitle: 'Serverless Tests'
        
    - script: 'if not exist "$(Agent.BuildDirectory)\TestResults\*.trx" exit 1'
  
  - job: Serverless_Tests_8
    displayName: 'Serverless Tests'
  
    steps:
    - checkout: none
    
    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'current'
        artifactName: 'TestBinaries'
        targetPath: '$(Agent.BuildDirectory)'
  
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          $address = $env:UseThisServerlessAddress
          $username = $env:UseThisServerlessUsername
          $password = $env:UseThisServerlessPassword 
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          Write-Host Testing against $address
          Test-NetConnection -Port 3142 $address
          New-LocalUser -Name $username -Password $securePassword -PasswordNeverExpires
          Add-LocalGroupMember -Group Administrators -Member $username
          $credential = New-Object System.Management.Automation.PSCredential $username, $securePassword
          netsh interface portproxy add v4tov4 listenport=3142 listenaddress=127.0.0.1 connectport=3142 connectaddress=$address
          netsh interface portproxy add v4tov4 listenport=3142 listenaddress=$env:ComputerName connectport=3142 connectaddress=$address
          Start-Process -Wait -Credential $credential -FilePath powershell -ArgumentList '-NoProfile -NoLogo -ExecutionPolicy Bypass -File "$(Agent.BuildDirectory)\RunServerlessTests500TimesInParallel.ps1"'
        displayName: 'Run Tests'
      env:
        UseThisServerlessUsername: $(ServerlessUsername)
        UseThisServerlessPassword: $(ServerlessPassword)
        UseThisServerlessAddress: $(ServerlessAddress)
  
    - task: PublishTestResults@2
      inputs:
        testRunner: VSTest
        testResultsFiles: '$(Agent.BuildDirectory)\TestResults\*.trx'
        failTaskOnFailedTests: true
        testRunTitle: 'Serverless Tests'
        
    - script: 'if not exist "$(Agent.BuildDirectory)\TestResults\*.trx" exit 1'
  
  - job: Serverless_Tests_9
    displayName: 'Serverless Tests'
  
    steps:
    - checkout: none
    
    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'current'
        artifactName: 'TestBinaries'
        targetPath: '$(Agent.BuildDirectory)'
  
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          $address = $env:UseThisServerlessAddress
          $username = $env:UseThisServerlessUsername
          $password = $env:UseThisServerlessPassword 
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          Write-Host Testing against $address
          Test-NetConnection -Port 3142 $address
          New-LocalUser -Name $username -Password $securePassword -PasswordNeverExpires
          Add-LocalGroupMember -Group Administrators -Member $username
          $credential = New-Object System.Management.Automation.PSCredential $username, $securePassword
          netsh interface portproxy add v4tov4 listenport=3142 listenaddress=127.0.0.1 connectport=3142 connectaddress=$address
          netsh interface portproxy add v4tov4 listenport=3142 listenaddress=$env:ComputerName connectport=3142 connectaddress=$address
          Start-Process -Wait -Credential $credential -FilePath powershell -ArgumentList '-NoProfile -NoLogo -ExecutionPolicy Bypass -File "$(Agent.BuildDirectory)\RunServerlessTests500TimesInParallel.ps1"'
        displayName: 'Run Tests'
      env:
        UseThisServerlessUsername: $(ServerlessUsername)
        UseThisServerlessPassword: $(ServerlessPassword)
        UseThisServerlessAddress: $(ServerlessAddress)
  
    - task: PublishTestResults@2
      inputs:
        testRunner: VSTest
        testResultsFiles: '$(Agent.BuildDirectory)\TestResults\*.trx'
        failTaskOnFailedTests: true
        testRunTitle: 'Serverless Tests'
        
    - script: 'if not exist "$(Agent.BuildDirectory)\TestResults\*.trx" exit 1'